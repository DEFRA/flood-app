# Flood Risk Outlook System

This folder contains the core logic for processing Flood Guidance Statement (FGS) data from the Met Office and Environment Agency into user-facing flood risk information for the Environment Agency's flood warning service.

## Overview

The flood outlook system processes data from the **Flood Guidance Statement (FGS)** - a joint Met Office and Environment Agency product - and generates two complementary outputs:

- **5-day flood risk forecasts**: Human-readable text describing flood risks for today through 4 days ahead
- **Interactive flood risk maps**: GeoJSON features showing geographic areas affected by flood risks

The system transforms complex meteorological and flood risk data into actionable information that helps communities prepare for potential flooding events.

## 5DF (Five Day Forecast) Generation

The system handles the 5-day flood forecast content differently depending on the context:

### National Overview Page
- **Source**: Comes directly from FGS `public_forecast.england_forecast` field
- **Processing**: No additional processing - displays raw FGS forecast text
- **Usage**: Shows national-level flood guidance without location filtering

### Location-Specific Pages  
- **Source**: Generated by `outlook-content-generator.js` from location-filtered risk matrices
- **Processing**: Filters FGS data to show only risks affecting the specific location, then generates human-readable text
- **Usage**: Provides personalized flood forecasts for individual locations

### Interactive Map Tooltips
- **Source**: Generated by `outlook-map.js` using pre-written content templates from `outlook-constants.js`
- **Processing**: Creates detailed popup messages for each map feature based on risk levels and sources
- **Usage**: Provides contextual flood risk information when users click on map areas

**Key Distinction**: National content comes unprocessed from FGS, while location and map content are generated through the system's processing pipeline to provide filtered, contextual information.

## Architecture

The system consists of four specialized components that transform raw flood guidance data into user-facing information:

### 1. `outlook-constants.js` - Business Rules Engine
**Core Purpose**: Central repository for all flood risk business logic and content definitions
- **Risk Level Definitions**: Enums for Impact (None, Minimal, Minor, Significant, Severe) and Likelihood (None, VeryLow, Low, Medium, High)
- **Valid Risk Combinations**: Set of 11 impact-likelihood pairs that constitute reportable flood risks (excludes very low likelihoods and minimal impacts)
- **Content Mappings**: Pre-written text for impacts, likelihoods, and location phrases used in forecast generation
- **Algorithm Configuration**: Sentence count thresholds, iteration limits, and processing priorities
- **Processing Rules**: Source ordering (River → Sea → Surface → Ground) and risk prioritization logic

**Key Role**: Single source of truth for all business rules. Changes here affect the entire system's behavior and output.

### 2. `outlook-matrix.js` - Geographic Risk Processor
**Core Purpose**: Converts raw FGS geographic data into structured risk matrices with optional location filtering
- **Matrix Structure**: Builds 5×4×2 arrays: [5 days][4 sources][impact, likelihood]
- **Geographic Filtering**: Uses Turf.js for polygon intersection testing to show only risks affecting user's location
- **Risk Aggregation**: Combines overlapping risk areas, taking maximum risk levels when multiple areas affect same day/source
- **Source Mapping**: Translates FGS source names (river, coastal, surface, ground) to array indices
- **Data Validation**: Handles malformed coordinates and missing data gracefully

**Key Role**: Transforms unstructured geographic flood data into queryable matrix format for content generation.

### 3. `outlook-content-generator.js` - Natural Language Generator
**Core Purpose**: Transforms risk matrices into human-readable 5-day flood forecasts following strict specification rules
- **Day Processing**: Filters invalid risk pairs, validates against business rules, generates day "fingerprints" for grouping
- **Temporal Grouping**: Combines consecutive days with identical risk patterns (Today/Tomorrow, Saturday through Monday, etc.)
- **Risk Categorization**: Groups risk combinations by impact/likelihood, determines optimal sentence count (1-4 sentences)
- **Sentence Construction**: Builds properly structured sentences with correct impact-likelihood-source ordering
- **Priority Logic**: Selects most important risk combinations when multiple exist, following severity and likelihood priorities

**Key Role**: Converts technical risk data into clear, actionable flood warnings that users can understand and act upon.

### 4. `outlook-map.js` - Interactive Map Generator
**Core Purpose**: Creates GeoJSON features for the `/api/outlook.geojson` endpoint powering interactive flood risk maps
- **Risk Calculation**: Uses local risk matrix to convert impact/likelihood pairs into visual risk levels (1-4)
- **Geometric Processing**: Handles inland polygons and coastal linestrings, buffers coastlines into visible polygons
- **Feature Generation**: Creates GeoJSON features with popup content, styling properties, and z-index ordering
- **Content Enrichment**: Groups sources with same risk levels, generates detailed popup messages using pre-written templates
- **Significance Filtering**: Only displays features with meaningful risk levels, skips very low impact risks

**Key Role**: Transforms geographic risk data into interactive map layers that users can explore and understand visually.

## Data Flow

The system processes FGS data through two independent pipelines that share the same business rules but serve different user needs:

**Content Generation Pipeline:**
```
Raw FGS Data (geographic risk areas)
       ↓
   outlook-matrix.js
   (geographic filtering → risk aggregation → 5×4×2 matrix)
       ↓
   outlook-content-generator.js
   (day processing → risk validation → sentence construction)
       ↓
   5-day flood risk forecast text
   (human-readable warnings for location pages)
```

**Interactive Map Pipeline:**
```
Raw FGS Data (geographic risk areas)
       ↓
   outlook-map.js
   (risk calculation → geometric processing → feature generation)
       ↓
   /api/outlook.geojson
   (GeoJSON FeatureCollection for interactive maps)
       ↓
   Visual flood risk areas on maps
   (clickable polygons with popup details)
```

**Shared Dependencies:**
- `outlook-constants.js` provides business rules, valid risk pairs, and content templates to both pipelines

## Key Business Rules

### Risk Assessment Framework
The system uses a 5×5 impact-likelihood matrix, but only specific combinations are considered reportable flood risks:

**Valid Risk Combinations** (11 total):
- Minor impact (2) + Low/Medium/High likelihood (2,3,4)
- Significant impact (3) + Low/Medium/High likelihood (2,3,4)
- Severe impact (4) + Low/Medium/High likelihood (2,3,4)

**Excluded Combinations**:
- Any Minimal impact (1) or None (0)
- Very Low likelihood (1) with Minor impact or higher
- Any None (0) values

### Content Generation Rules
**Sentence Count Logic**:
- 1-2 unique impacts/likelihoods → 1 sentence
- 3-4 unique impacts/likelihoods → 2 sentences
- 5 unique impacts/likelihoods → 3 sentences
- 6+ unique impacts/likelihoods → 4 sentences maximum

**Sentence Structure**:
- **First sentence**: Full Impact Description + Likelihood + Location ("Localised property flooding and travel disruption is possible in riverside areas")
- **Subsequent sentences**: Capitalized Location + lowercase Impact + Likelihood ("In coastal areas, severe or widespread property flooding and travel disruption is expected")

**Risk Prioritization**:
1. Sort by impact severity (Severe → Significant → Minor)
2. Within same impact, sort by likelihood (High → Medium → Low)
3. Within same impact/likelihood, sort by lowest source ID (River → Sea → Surface → Ground)

### Geographic Processing Rules
**Location Filtering**: Uses bounding box intersection to show only risks affecting user's area
**Risk Aggregation**: Takes maximum risk levels when multiple geographic areas overlap
**Coordinate Validation**: Handles malformed geographic data gracefully

### Map Visualization Rules
**Feature Filtering**: Only displays risks with impact > Minimal, except Minor impact with Very Low likelihood
**Geometric Processing**: Converts coastal linestrings to polygons with 1-mile buffer for visibility
**Layer Ordering**: Higher risk levels get higher z-index values for proper map rendering

## Testing

Run the full test suite:
```bash
npm run unit-test
```

Key test files:
- `test/models/outlook-map.js` - Interactive map generation tests
- `test/models/outlook-matrix.js` - Geographic risk processing tests
- `test/models/outlook-content-generator.js` - Content generation tests
- `test/data/outlook-cases.js` - Test fixtures and edge cases

## Configuration

All business rules and thresholds are defined in `outlook-constants.js`:
- Risk level definitions
- Valid risk combinations
- Content templates
- Algorithm limits